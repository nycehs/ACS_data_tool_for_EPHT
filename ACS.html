<!DOCTYPE html>
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="" />
    <meta name="author" content="" />
</head>

<link rel="stylesheet" href="style.css" />

<script type="text/javascript" src="https://d3js.org/d3.v3.js"></script>
<script type="text/javascript" src="https://code.jquery.com/jquery-3.6.0.js"></script>
<script type="text/javascript" src="geography_lookupNew.js"></script>
<script type="text/javascript" src="queue.v1.min.js"></script>
<script type="text/javascript" src="modernizr-custom.js"></script>
<script type="text/javascript" src="excellentexport.js"></script>


<body>
    <div id="controls">
        <label>Indicator:</label>
        <select id='ind_options'></select>

        <label>Year:</label>
        <select id='year_options'>

            <!-- add new years here -->
            <option value="2019">2015-2019</option>
            <option value="2018">2014-2018</option>
            <option value="2017">2013-2017</option>
            <option value="2016">2012-2016</option>
            <option value="2015">2011-2015</option>
            <option value="2014">2010-2014</option>
        </select>

        <a href="#" class="myButton" id="get_data">Get Data</a>
        <a href="#" class="export myButton" id="exportChrome" style="display:none">Export Table to CSV</a>
        <a href="#" class="export myButton" id="exportIE" style="display:none" onclick="return ExcellentExport.csv(this, 'datatableCsv');">Export Table to CSV</a>
        <a href="ACS_Documentation.pdf" style="margin: 0px 0px 10px 10px;" id="download">Documentation</a>
        <input id="chkrank" type="checkbox" name="vehicle" />Include Rank<br>
    </div>


    <div id='tab_loc' class="CSSTableGenerator"></div>
</body>

<script type="text/javascript">


    //===========================================================================//
    // setting initial variable values
    //===========================================================================//
    
    // document.domain = 'https://census.gov';
    //Census API 5-year ACS URL

    var api_url = 'https://api.census.gov/data';
    var my_key = 'c8b757f7e16f108647304131056db5bb63ba2e93';

    //---------------------------------------------------------------------------//
    // indicators whose definitions and variables haven't changed
    //---------------------------------------------------------------------------//

    // denom = complete denominator
    // denom2 = combined with number to form complete denominator

    var census_param = [
    {
        indicator: "Poverty", table: "POVERTY STATUS IN THE PAST 12 MONTHS BY AGE", source: 'acs/acs5',
        variables: [
        { name: "B17020_001E", label: "Estimate!!Total", type: "denom" },
        { name: "B17020_002E", label: "Estimate!!Total!!Income in the past 12 months below poverty level", type: "num" }
        ]
    },
    {
        indicator: "Poverty TOTAL", table: "POVERTY STATUS IN THE PAST 12 MONTHS BY AGE", source: 'acs/acs5',
        variables: [
        { name: "B17020_001E", label: "Estimate!!Total", type: "denom" },
        { name: "B17020_001E", label: "Estimate!!Total", type: "num" }
        ]
    },
    {
        indicator: "Children Under 5 years old in Poverty", table: "POVERTY STATUS IN THE PAST 12 MONTHS BY SEX BY AGE", source: 'acs/acs5',
        variables: [
        { name: "B17001_004E", label: "Estimate!!Total!!Income in the past 12 months below poverty level!!Male!!Under 5 years", type: "num" },
        { name: "B17001_033E", label: "Estimate!!Total!!Income in the past 12 months at or above poverty level!!Male!!Under 5 years", type: "denom2" },
        { name: "B17001_018E", label: "Estimate!!Total!!Income in the past 12 months below poverty level!!Female!!Under 5 years", type: "num" },
        { name: "B17001_047E", label: "Estimate!!Total!!Income in the past 12 months at or above poverty level!!Female!!Under 5 years", type: "denom2" }
        ]
    },
    {
        indicator: "Owner-Occupied Homes", table: "SELECTED HOUSING CHARACTERISTICS", source: 'acs/acs5/profile',
        variables: [
        { name: "DP04_0045E", label: "Estimate!!HOUSING TENURE!!Occupied housing units", type: "denom" },
        { name: "DP04_0046E", label: "Estimate!!HOUSING TENURE!!Occupied housing units!!Owner-occupied", type: "num" }
        ]
    },
    {
        indicator: "Foreign-Born", table: "SELECTED SOCIAL CHARACTERISTICS IN THE UNITED STATES", source: 'acs/acs5/profile',
        variables: [
        { name: "DP02_0086E", label: "Estimate!!PLACE OF BIRTH!!Total population", type: "denom" },
        { name: "DP02_0092E", label: "Estimate!!PLACE OF BIRTH!!Total population!!Foreign born", type: "num" }
        ]
    },
    {
        indicator: "Crowding (> 1 person/room)", table: "SELECTED HOUSING CHARACTERISTICS", source: 'acs/acs5/profile',
        variables: [
        { name: "DP04_0076E", label: "Estimate!!OCCUPANTS PER ROOM!!Occupied housing units", type: "denom" },
        { name: "DP04_0078E", label: "Estimate!!OCCUPANTS PER ROOM!!Occupied housing units!!1.01 to 1.50", type: "num" },
        { name: "DP04_0079E", label: "Estimate!!OCCUPANTS PER ROOM!!Occupied housing units!!1.51 or more", type: "num" }
        ]
    },
    {
        indicator: "Pre-1950 Homes", table: "YEAR STRUCTURE BUILT", source: 'acs/acs5',
        variables: [
        { name: "B25034_011E", label: "Estimate!!Total!!Built 1939 or earlier", type: "num" },
        { name: "B25034_010E", label: "Estimate!!Total!!Built 1940 to 1949", type: "num" },
        { name: "B25034_001E", label: "Estimate!!Total", type: "denom2" }
        ]
    },
    {
        indicator: "Race and Ethnicity"
    },
    {
        indicator: "Total Population", table: "TOTAL POPULATION", source: 'acs/acs5', 
        variables: [ 
        { name: "B01003_001E", label: "Estimate!!Total", type: "denom" }, 
        { name: "B01003_001E", label: "Estimate!!Total", type: "num" } 	
        ]
    },    
    {
        indicator: "High School Graduation", table: "SELECTED SOCIAL CHARACTERISTICS IN THE UNITED STATES", source: 'acs/acs5/profile', 
        variables: [ 
        { name: "DP02_0058E", label: "Estimate!!EDUCATIONAL ATTAINMENT!!Population 25 years and over", type: "denom" }, 
        { name: "DP02_0061E", label: "Estimate!!EDUCATIONAL ATTAINMENT!!Population 25 years and over!!High school graduate (includes equivalency)", type: "num" },
        { name: "DP02_0062E", label: "Estimate!!EDUCATIONAL ATTAINMENT!!Population 25 years and over!!Some college no degree", type: "num" }, 
        { name: "DP02_0063E", label: "Estimate!!EDUCATIONAL ATTAINMENT!!Population 25 years and over!!Associate's degree", type: "num" },
        { name: "DP02_0064E", label: "Estimate!!EDUCATIONAL ATTAINMENT!!Population 25 years and over!!Bachelor's degree", type: "num" }, 
        { name: "DP02_0065E", label: "Estimate!!EDUCATIONAL ATTAINMENT!!Population 25 years and over!!Graduate or professional degree", type: "num" } 
        ]
    },
    {
        indicator: "Rent Burdened Households", table: "GROSS RENT AS A PERCENTAGE OF HOUSEHOLD INCOME IN THE PAST 12 MONTHS", source: 'acs/acs5', 
        variables: [ 
        { name: "B25070_001E", label: "Estimate!!Total", type: "denom" }, 
        { name: "B25070_007E", label: "Estimate!!Total!!30.0 to 34.9 percent", type: "num" },
        { name: "B25070_008E", label: "Estimate!!Total!!35.0 to 39.9 percent", type: "num" },
        { name: "B25070_009E", label: "Estimate!!Total!!40.0 to 49.9 percent", type: "num" }, 
        { name: "B25070_010E", label: "Estimate!!Total!!50.0 percent or more", type: "num" } 
        ]
    },	
    {
        indicator: "Limited English", table: "SELECTED SOCIAL CHARACTERISTICS IN THE UNITED STATES", source: 'acs/acs5/profile', 
        variables: [ 
        { name: "DP02_0110E", label: "Estimate!!LANGUAGE SPOKEN AT HOME!!Population 5 years and over", type: "denom" }, 
        { name: "DP02_0113E", label: "Estimate!!LANGUAGE SPOKEN AT HOME!!Population 5 years and over!!Language other than English!!Speak English less than 'very well'", type: "num" }
        ]
    },		
    {
        indicator: "Unemployment", table: "EMPLOYMENT STATUS FOR THE POPULATION 16 YEARS AND OVER", source: 'acs/acs5', 
        variables: [ 
        { name: "B23025_003E", label: "Estimate!!Total!!In labor force!!Civilian labor force", type: "denom" }, 
        { name: "B23025_005E", label: "Estimate!!Total!!In labor force!!Civilian labor force!!Unemployed", type: "num" } 
        ]
    },	
    {
        indicator: "Older Adults Living Alone", table: "LIVING ARRANGEMENTS OF ADULTS 18 YEARS AND OVER BY AGE", source: 'acs/acs5', 
        variables: [ 
        { name: "B09021_023E", label: "Estimate!!Total!!65 years and over!!Lives alone", type: "num" }, 
        { name: "B09021_022E", label: "Estimate!!Total!!65 years and over", type: "denom" } 	
        ]
    },
    {
        indicator: "Older Adults Living Alone2", table: "B09020. Relationship by Household Type (Including Living Alone) for the Population 65 Years and Over", source: 'acs5', 
        variables: [ 
        { name: "B09020_001E", label: "Total:", type: "denom" }, 
        { name: "B09020_015E", label: "In households:!!In nonfamily households:!!Householder:!!Male:!!Living alone", type: "num" },
        { name: "B09020_018E", label: "In households:!!In nonfamily households:!!Householder:!!Female:!!Living alone", type: "num" }
        ]
    },
    ];

    //---------------------------------------------------------------------------//
    // variables for race indicators pre-2014
    //---------------------------------------------------------------------------//

    var race_var_before_2014 = [
    {
        indicator: "Hispanic or Latino (of any race)", table: "ACS DEMOGRAPHIC AND HOUSING ESTIMATES", source: 'acs/acs5/profile',
        variables: [
        { name: "DP05_0065E", label: "Estimate!!HISPANIC OR LATINO AND RACE!!Total population", type: "denom" },
        { name: "DP05_0066E", label: "Estimate!!HISPANIC OR LATINO AND RACE!!Total population!!Hispanic or Latino (of any race)", type: "num" }
        ]
    },
    {
        indicator: "White alone", table: "ACS DEMOGRAPHIC AND HOUSING ESTIMATES", source: 'acs/acs5/profile',
        variables: [
        { name: "DP05_0065E", label: "Estimate!!HISPANIC OR LATINO AND RACE!!Total population", type: "denom" },
        { name: "DP05_0072E", label: "Estimate!!HISPANIC OR LATINO AND RACE!!Total population!!Not Hispanic or Latino!!White alone", type: "num" }
        ]
    },
    {
        indicator: "Black or African American alone", table: "ACS DEMOGRAPHIC AND HOUSING ESTIMATES", source: 'acs/acs5/profile',
        variables: [
        { name: "DP05_0065E", label: "Estimate!!HISPANIC OR LATINO AND RACE!!Total population", type: "denom" },
        { name: "DP05_0073E", label: "Estimate!!HISPANIC OR LATINO AND RACE!!Total population!!Not Hispanic or Latino!!Black or African American alone", type: "num" }
        ]
    },
    {
        indicator: "Asian alone", table: "ACS DEMOGRAPHIC AND HOUSING ESTIMATES", source: 'acs/acs5/profile',
        variables: [
        { name: "DP05_0065E", label: "Estimate!!HISPANIC OR LATINO AND RACE!!Total population", type: "denom" },
        { name: "DP05_0075E", label: "Estimate!!HISPANIC OR LATINO AND RACE!!Total population!!Not Hispanic or Latino!!Asian alone", type: "num" }
        ]
    }
    ];


    //---------------------------------------------------------------------------//
    // variables for race indicators post-2014
    //---------------------------------------------------------------------------//

    var race_var_after_2014 = [
    {
        indicator: "Hispanic or Latino (of any race)", table: "ACS DEMOGRAPHIC AND HOUSING ESTIMATES", source: 'acs/acs5/profile',
        variables: [
        { name: "DP05_0033E", label: "Estimate!!HISPANIC OR LATINO AND RACE!!Total population", type: "denom" },
        { name: "DP05_0071E", label: "Estimate!!HISPANIC OR LATINO AND RACE!!Total population!!Hispanic or Latino (of any race)", type: "num" }
        ]
    },
    {
        indicator: "White alone", table: "ACS DEMOGRAPHIC AND HOUSING ESTIMATES", source: 'acs/acs5/profile',
        variables: [
        { name: "DP05_0033E", label: "Estimate!!HISPANIC OR LATINO AND RACE!!Total population", type: "denom" },
        { name: "DP05_0037E", label: "Estimate!!HISPANIC OR LATINO AND RACE!!Total population!!Not Hispanic or Latino!!White alone", type: "num" }
        ]
    },
    {
        indicator: "Black or African American alone", table: "ACS DEMOGRAPHIC AND HOUSING ESTIMATES", source: 'acs/acs5/profile',
        variables: [
        { name: "DP05_0033E", label: "Estimate!!HISPANIC OR LATINO AND RACE!!Total population", type: "denom" },
        { name: "DP05_0038E", label: "Estimate!!HISPANIC OR LATINO AND RACE!!Total population!!Not Hispanic or Latino!!Black or African American alone", type: "num" }
        ]
    },
    {
        indicator: "Asian alone", table: "ACS DEMOGRAPHIC AND HOUSING ESTIMATES", source: 'acs/acs5/profile',
        variables: [
        { name: "DP05_0033E", label: "Estimate!!HISPANIC OR LATINO AND RACE!!Total population", type: "denom" },
        { name: "DP05_0044E", label: "Estimate!!HISPANIC OR LATINO AND RACE!!Total population!!Not Hispanic or Latino!!Asian alone", type: "num" }
        ]
    }
    ];
    
    //---------------------------------------------------------------------------//
    // setting up UI
    //---------------------------------------------------------------------------//

    //populate indicator dropdown

    var options = $("#ind_options");
    
    $.each(census_param, function (i, d) {
        options.append($("<option />").val(i).text(d.indicator));
    });
    
    
    //===========================================================================//
    // defining data-getting functions
    //===========================================================================//

    //---------------------------------------------------------------------------//
    // getdata (which calls hit_api with the correct indicator(s))
    //---------------------------------------------------------------------------//
    
    //function to display data in table
    function getdata(i_val, y_val) {

        // if this is the Race and Ethnicity indicator, check the year, then loop through the constituent indicators
        if (census_param[i_val].indicator == "Race and Ethnicity") {

            if (y_val <= 2014) {
                race_var_before_2014.forEach(indicator => hit_api(indicator, y_val));
            }
            else {
                race_var_after_2014.forEach(indicator => hit_api(indicator, y_val));
            }
        }
        else {
            hit_api(census_param[i_val], y_val);
        }
    }

    //---------------------------------------------------------------------------//
    // hit_api (which constructs API calls from paramaters)
    //---------------------------------------------------------------------------//
    
    var nta_uhf_data;
    
    function hit_api(census_param, year) {

        // reset these values each time we hit the API

        nta_uhf_data = {};
        
        census_param['year'] = year; 

        //delete old table
        $('#tab_loc').empty();

        //create table and add header corresponding to EPHT Indicator Tool input fields
        $('#tab_loc').append('<table id="datatableCsv">');

        var row = $('<tr>');
        var census_var = census_param.variables;
        var this_url = api_url + '/' + year + '/' + census_param.source + '?';

        row.append($('<th>').text('IndicatorName'));
        row.append($('<th>').text('MeasureType'));
        row.append($('<th>').text('GeoType'));
        row.append($('<th>').text('GeoEntity'));
        row.append($('<th>').text('TimePeriod'));
        row.append($('<th>').text('DataValue'));
        row.append($('<th>').text('UnreliabilityFlag'));
        row.append($('<th>').text('ConfidenceInterval'));
        $('#tab_loc table').append(row);
        
        
        // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //
        // constructing paths
        // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //

        //COUNTY PATH
        var county = $.map(county2boro, function (n, i) { return n.county; });
        var county_path = this_url + "key=" + my_key + "&get=";
        for (i = 0; i < census_var.length; ++i) {
            county_path += (i == (census_var.length - 1)) ? census_var[i].name : census_var[i].name + ",";
        }
        county_path += "&for=county:" + county.toString() + "&in=state:36";
        console.log("county_path:", county_path);
        
        //ZCTA PATH
        var zcta = $.map(zcta2UHF, function (n, i) { return n.ZCTA; });
        var zcta_path = this_url + "key=" + my_key + "&get=";
        for (i = 0; i < census_var.length; ++i) {
            zcta_path += (i == (census_var.length - 1)) ? census_var[i].name : census_var[i].name + ",";
        }
        zcta_path += "&for=zip+code+tabulation+area:" + zcta.toString() + "&in=state:36";
        console.log("zcta_path:", zcta_path);
        
        //PUMA PATH
        var puma = $.map(puma2subboro, function (n, i) { return n.PUMA; });
        var puma_path = this_url + "key=" + my_key + "&get=";
        for (i = 0; i < census_var.length; ++i) {
            puma_path += (i == (census_var.length - 1)) ? census_var[i].name : census_var[i].name + ",";
        }
        puma_path += "&for=public+use+microdata+area:" + puma.toString() + "&in=state:36";
        console.log("puma_path:", puma_path);
        
        //PUMA CD
        var pumacd = $.map(puma2subboro, function (n, i) { return n.PUMA; });
        var puma_path_cd = this_url + "key=" + my_key + "&get=";
        for (i = 0; i < census_var.length; ++i) {
            puma_path_cd += (i == (census_var.length - 1)) ? census_var[i].name : census_var[i].name + ",";
        }
        puma_path_cd += "&for=public+use+microdata+area:" + pumacd.toString() + "&in=state:36";
        console.log("puma_path_cd:", puma_path_cd)
        
        //BX
        var ntaBX = $.map(tractToNTABX, function (n, i) { return n.TRACT; });
        var nta_pathBX = this_url + "key=" + my_key + "&get=";
        for (i = 0; i < census_var.length; ++i) {
            nta_pathBX += (i == (census_var.length - 1)) ? census_var[i].name : census_var[i].name + ",";
        }
        nta_pathBX += "&for=tract:" + ntaBX.toString() + "&in=state:36+county:005";
        console.log("nta_pathBX:", nta_pathBX)
        
        //BK
        var ntaBK = $.map(tractToNTABK, function (n, i) { return n.TRACT; });
        var nta_pathBK = this_url + "key=" + my_key + "&get=";
        for (i = 0; i < census_var.length; ++i) {
            nta_pathBK += (i == (census_var.length - 1)) ? census_var[i].name : census_var[i].name + ",";
        }
        nta_pathBK += "&for=tract:" + ntaBK.toString() + "&in=state:36+county:047";
        console.log("nta_pathBK:", nta_pathBK);
        
        //MN
        var ntaMN = $.map(tractToNTAMN, function (n, i) { return n.TRACT; });
        var nta_pathMN = this_url + "key=" + my_key + "&get=";
        for (i = 0; i < census_var.length; ++i) {
            nta_pathMN += (i == (census_var.length - 1)) ? census_var[i].name : census_var[i].name + ",";
        }
        nta_pathMN += "&for=tract:" + ntaMN.toString() + "&in=state:36+county:061";
        console.log("nta_pathMN:", nta_pathMN);
        
        //QN
        var ntaQN = $.map(tractToNTAQN, function (n, i) { return n.TRACT; });
        var nta_pathQN = this_url + "key=" + my_key + "&get=";
        for (i = 0; i < census_var.length; ++i) {
            nta_pathQN += (i == (census_var.length - 1)) ? census_var[i].name : census_var[i].name + ",";
        }
        nta_pathQN += "&for=tract:" + ntaQN.toString() + "&in=state:36+county:081";
        console.log("nta_pathQN:", nta_pathQN);
        
        //SI
        var ntaSI = $.map(tractToNTASI, function (n, i) { return n.TRACT; });
        var nta_pathSI = this_url + "key=" + my_key + "&get=";
        for (i = 0; i < census_var.length; ++i) {
            nta_pathSI += (i == (census_var.length - 1)) ? census_var[i].name : census_var[i].name + ",";
        }
        nta_pathSI += "&for=tract:" + ntaSI.toString() + "&in=state:36+county:085";
        console.log("nta_pathSI:", nta_pathSI);
        
        
        // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //
        // get and parse json
        // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //

        $.getJSON(county_path, function (city_json) {
            $.getJSON(county_path, function (county_json) {
                $.getJSON(puma_path, function (puma_json) {
                    $.getJSON(zcta_path, function (zcta_json) {
                        $.getJSON(puma_path_cd, function (cd_json) {
                            $.getJSON(nta_pathBX, function (BX_nta_json) {
                                $.getJSON(nta_pathBK, function (BK_nta_json) {
                                    $.getJSON(nta_pathMN, function (MN_nta_json) {
                                        $.getJSON(nta_pathQN, function (QN_nta_json) {
                                            $.getJSON(nta_pathSI, function (SI_nta_json) {
                                                parse_json(census_param, city_json, "county", 'county', 'Citywide', county2boro);
                                                parse_json(census_param, county_json, "county", 'county', 'Borough', county2boro);
                                                parse_json(census_param, puma_json, "public use microdata area", 'PUMA', 'Subboro', puma2subboro);
                                                parse_json(census_param, zcta_json, "zip code tabulation area", 'ZCTA', 'UHF42', zcta2UHF);
                                                parse_json(census_param, cd_json, "public use microdata area", 'PUMA', 'CD', puma2subboro);
                                                parse_json(census_param, BX_nta_json, "tract", 'TRACT', 'NTA', tractToNTABX);
                                                parse_json(census_param, BK_nta_json, "tract", 'TRACT', 'NTA', tractToNTABK);
                                                parse_json(census_param, MN_nta_json, "tract", 'TRACT', 'NTA', tractToNTAMN);
                                                parse_json(census_param, QN_nta_json, "tract", 'TRACT', 'NTA', tractToNTAQN);
                                                parse_json(census_param, SI_nta_json, "tract", 'TRACT', 'NTA', tractToNTASI);
                                            }).fail(data => alert(data.responseText));
                                        }).fail(data => alert(data.responseText));
                                    }).fail(data => alert(data.responseText));
                                }).fail(data => alert(data.responseText));
                            }).fail(data => alert(data.responseText));
                        }).fail(data => alert(data.responseText));
                    }).fail(data => alert(data.responseText));
                }).fail(data => alert(data.responseText));
            }).fail(data => alert(data.responseText));
        }).fail(data => alert(data.responseText));
        
    }

    //---------------------------------------------------------------------------//
    // parse_json
    //---------------------------------------------------------------------------//

    function parse_json(census_param, c_json, c_geo, from_geo, to_geo, geos) {
        
        console.log("from_geo [parse_json]:", from_geo);
        console.log("to_geo [parse_json]:", to_geo);
        
        // ACS 5-year data represents middle year
        var this_year = census_param.year - 2;
        var census_var = census_param.variables;

        // create table from Geo to geo table according to lookup
        var geoOL = {};
        $.each(geos, function (i, val) {
            geoOL[geos[i][from_geo]] = geos[i][to_geo];
        });
        
        // grab variable names // Get all title for Key value pair
        var c_var = c_json.shift();
        
        // assign variable names as keys 
        //  Assign key value accoridng to c_var table= table name, state=

        var cdata2 = []; // again all data with object key value

        for (i = 0; i < c_json.length; ++i) {
            var c = c_json[i];
            var temp_OL = {};
            for (j = 0; j < c.length; ++j) {
                temp_OL[c_var[j]] = c[j];
            }
            cdata2.push(temp_OL);
        }
        
        //get type for each variable name 
        // table name with num or denonminator assignmrnt type_OL

        var type_OL = {};

        for (i = 0; i < census_var.length; ++i) {
            type_OL[census_var[i].name] = census_var[i].type;
        }
        
        //create object for each geographic entity with variables summed by type
        var cdata = {};

        for (i = 0; i < cdata2.length; ++i) {

            var temp_OL = {};
            var p = cdata2[i];

            for (var key in p) {

                // all data arrary will itrate
                if (p.hasOwnProperty(key)) {

                    // only take table values
                    if (type_OL.hasOwnProperty(key)) {

                        //(type_OL
                        if (temp_OL.hasOwnProperty(type_OL[key])) {
                            temp_OL[type_OL[key]] = temp_OL[type_OL[key]] + parseInt(p[key]);
                        }
                        else {
                            temp_OL[type_OL[key]] = parseInt(p[key]);
                        }
                    }
                }
            }
            temp_OL[to_geo] = geoOL[p[c_geo]];
            cdata[p[c_geo]] = temp_OL;
        }
        
        // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //
        // aggregate by geography
        // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //

        var uhf_data = {};

        for (var key1 in cdata) {

            var key = cdata[key1][to_geo];

            if (!uhf_data[key]) {
                uhf_data[key] = {};
            }

            for (var key2 in cdata[key1]) {

                if (key2 !== to_geo) {
                    if (!uhf_data[key][key2]) {
                        uhf_data[key][key2] = parseInt(cdata[key1][key2]);
                    }
                    else {
                        uhf_data[key][key2] += parseInt(cdata[key1][key2]);
                    }
                }
            }
        }
        
        // don't need to test for flag here: as long as to_geo != NTA, flag will only 
        //  ever be 0. flag can only be > 0 when to_geo == NTA 
        
        var uhf_data = populate_stats(uhf_data, census_param.indicator)
        DrawTable(uhf_data, to_geo, this_year, census_param.indicator);
        
    }
    

    //---------------------------------------------------------------------------//
    // DrawTable
    //---------------------------------------------------------------------------//

    function DrawTable(uhf_data, to_geo, this_year, indicator) {

        // table only clears when hit_api is called, so looping through race indicators just keeps appending rows. 
        //  export functions take data from the html table, so everything works.
        
        for (var key in uhf_data) {

            var keyArray = key.split(',');
            // cd devide logic

            for (var i = 0; i < keyArray.length; i++) {
                
                var temp_OL = uhf_data[key];
                var row = $('<tr>');

                row.append($('<td>').text(indicator));      // IndicatorName
                row.append($('<td>').text('Number'));       // MeasureType
                row.append($('<td>').text(to_geo));         // GeoType
                row.append($('<td>').text(keyArray[i]));    // GeoEntity
                row.append($('<td>').text((this_year - 2) + '-' + ((this_year + 2) - 2000))); // TimePeriod
                row.append($('<td>').text(temp_OL["num"])); // DataValue
                row.append($('<td>').text('0'));            // UnreliabilityFlag
                row.append($('<td>').text(''));             // ConfidenceInterval
                
                $('#tab_loc table').append(row);
                
                var row = $('<tr>');
                
                // might be able to replace these duplicated calculations by declaring a `test_ind` var inside of `parse_json`. would be available to
                //  later functions.
                
                if (indicator === "Children Under 6 in Poverty" || indicator === "Children Under 5 years old in Poverty") {
                    var test_ind = d3.round((100 * (temp_OL["num"] / (temp_OL["denom2"] + temp_OL["num"]))), 2);
                }
                else if (!temp_OL["denom"]) {
                    var test_ind = d3.round((100 * (temp_OL["num"] / (temp_OL["denom2"]))), 2);
                }
                else {
                    var test_ind = d3.round((100 * (temp_OL["num"] / temp_OL["denom"])), 2);
                }
                
                row.append($('<td>').text(indicator));   // IndicatorName
                row.append($('<td>').text('Percent'));   // MeasureType
                row.append($('<td>').text(to_geo));      // GeoType
                row.append($('<td>').text(keyArray[i])); // GeoEntity
                row.append($('<td>').text((this_year - 2) + '-' + ((this_year + 2) - 2000))); // TimePeriod
                
                if (!isNaN(test_ind)) {
                    row.append($('<td>').text(test_ind)); // DataValue
                }
                else {
                    row.append($('<td>').text(0)); // DataValue
                }
                
                row.append($('<td>').text('0')); // UnreliabilityFlag
                row.append($('<td>').text(''));  // ConfidenceInterval
                
                $('#tab_loc table').append(row);
                
                if (to_geo != 'Citywide' && document.getElementById("chkrank").checked ) {
                      if (to_geo != 'Borough' && document.getElementById("chkrank").checked) {
                        var row = $('<tr>');
                        row.append($('<td>').text(indicator));          // IndicatorName
                        row.append($('<td>').text('Rank'));             // MeasureType
                        row.append($('<td>').text(to_geo));             // GeoType
                        row.append($('<td>').text(keyArray[i]));        // GeoEntity
                        row.append($('<td>').text((this_year - 2) + '-' + ((this_year + 2) - 2000))); // TimePeriod
                        row.append($('<td>').text(temp_OL["rankper"])); // DataValue
                        row.append($('<td>').text('0'));                // UnreliabilityFlag
                        row.append($('<td>').text(''));                 // ConfidenceInterval
                        $('#tab_loc table').append(row);
                    }
                }
            }
        }
    }
    
    
    //---------------------------------------------------------------------------//
    // populate_stats
    //---------------------------------------------------------------------------//
    
    function populate_stats(uhf_data, indicator) {
        
        var dataNumber = [];
        var dataPercent = [];
        var range_array = [];
        var leg_no = 3;
        var ranks = [];
        var ranksPer = [];

        for (var key in uhf_data) {

            var temp_OL = uhf_data[key];
            dataNumber.push(temp_OL["num"]);

        }
        
        for (var key in uhf_data) {

            var temp_OL = uhf_data[key];

            // put here: logical test for race indicator, then renaming of indicators

            if (indicator == "Children Under 6 in Poverty" || indicator == "Children Under 5 years old in Poverty") {

                var test_ind = d3.round((100 * (temp_OL["num"] / (temp_OL["denom2"] + temp_OL["num"]))), 2);

                if (!isNaN(test_ind)) {
                    dataPercent.push(test_ind);
                }
                else {
                    dataPercent.push(0);
                }
            }

            else if (!temp_OL["denom"]) {

                var test_ind = d3.round((100 * (temp_OL["num"] / (temp_OL["denom2"]))), 2);

                if (!isNaN(test_ind)) {
                    dataPercent.push(test_ind);
                }
                else {
                    dataPercent.push(0);
                }
            }
            
            else {

                var test_ind = d3.round((100 * (temp_OL["num"] / temp_OL["denom"])), 2);

                if (!isNaN(test_ind)) {
                    dataPercent.push(test_ind);
                }
                else {
                    dataPercent.push(0);
                }
            }
        }
        
        data_quantile = d3.scale.quantile();
        data_quantile.domain(dataNumber);
        
        range_array.length = 0;
        for (i = 0; i < leg_no; i++) {
            range_array[i] = i + 1
        }
        
        data_quantile.range(range_array);
        for (var i = 0; i < dataNumber.length; i++) {
            var f = dataNumber[i];
            var q = data_quantile(f);
            ranks.push(q);
        }
        
        var i = 0;
        for (var key in uhf_data) {
            uhf_data[key]["rank"] = ranks[i];
            i++;
        }
        
        ///percent disparity
        data_quantile.domain(dataPercent);
        for (var i = 0; i < dataPercent.length; i++) {
            var f = dataPercent[i];
            var q = data_quantile(f);
            ranksPer.push(q);
        }

        // Add to orignal node
        var i = 0;
        for (var key in uhf_data) {
            uhf_data[key]["rankper"] = ranksPer[i];
            i++;
        }
        
        return uhf_data;
        
    }
    
    
    //---------------------------------------------------------------------------//
    // get and download
    //---------------------------------------------------------------------------//
    
    // function to download as CSV from http://jsfiddle.net/terryyounghk/KPEGU/
    
    $(document).ready(function () {
        
        // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //
        // exportTableToCSV
        // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //
        
        function exportTableToCSV($table, filename) {
            
            // this downloads the data from the html table
            
            var $rows = $table.find('tr:has(th,td)'),
            
            // Temporary delimiter characters unlikely to be typed by keyboard
            //  This is to avoid accidentally splitting the actual contents
            
            tmpColDelim = String.fromCharCode(11), // vertical tab character
            tmpRowDelim = String.fromCharCode(0), // null character
            
            // actual delimiter characters for CSV format
            colDelim = '","',
            rowDelim = '"\r\n"',
            
            // Grab text from table into CSV formatted string
            csv = '"' + $rows.map(function (i, row) {
                var $row = $(row),
                $cols = $row.find('th,td');
                
                return $cols.map(function (j, col) {
                    var $col = $(col),
                    text = $col.text();
                    
                    return text.replace('"', '""'); // escape double quotes
                    
                }).get().join(tmpColDelim);
                
            }).get().join(tmpRowDelim)
            .split(tmpRowDelim).join(rowDelim)
            .split(tmpColDelim).join(colDelim) + '"',
            
            // Data URI
            csvData = 'data:application/csv;charset=utf-8,' + encodeURIComponent(csv);
            
            $(this)
            .attr({
                'download': filename,
                'href': csvData,
                'target': '_blank'
            });
        }
        
        
        // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //
        // get data (and set indicator & year options)
        // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //

        var iy_vals = [];
        var ind;
        
        $("#get_data").click(function (event) {
            
            event.preventDefault();
            
            // setting indicator and year values when the "Get Data" button is clicked. Because of the assignment 
            //  to `iy_vals`, they persist and are readable by the export function when the "Export" button is clicked.
            //  This allows us to save files named with indicator and year, but also ensure that they're the same values
            //  that are in the data we downloaded.
            
            var ind = document.getElementById("ind_options");
            var i_val = ind.options[ind.selectedIndex].value;
            
            var yr = document.getElementById("year_options");
            var y_val = yr.options[yr.selectedIndex].value;
            
            getdata(i_val, y_val);
            
            iy_vals = [i_val, y_val]
            
            console.log("[i_val, y_val]:", iy_vals)
            
        });
        
        
        // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //
        // export
        // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //

        // This must be a hyperlink
        $("#exportChrome").on('click', function (event) {
            
            console.log("export:", iy_vals);
            
            var year = iy_vals[1];
            var indicator = census_param[iy_vals[0]].indicator
            
            // CSV
            exportTableToCSV.apply(this, [$('#tab_loc>table'), 'ACS ' + indicator + ' ' + year + '.csv']);
            
            // IF CSV, don't do event.preventDefault() or return false
            // We actually need this to be a typical hyperlink
        });        
        
        
        // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //
        // set BrowserDetect
        // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //

        $(document).ready(function () {
            
            var BrowserDetect = {
                init: function () {
                    this.browser = this.searchString(this.dataBrowser) || "Other";
                    this.version = this.searchVersion(navigator.userAgent) || this.searchVersion(navigator.appVersion) || "Unknown";
                },
                searchString: function (data) {
                    for (var i = 0; i < data.length; i++) {
                        var dataString = data[i].string;
                        this.versionSearchString = data[i].subString;
                        
                        if (dataString.indexOf(data[i].subString) !== -1) {
                            return data[i].identity;
                        }
                    }
                },
                searchVersion: function (dataString) {
                    var index = dataString.indexOf(this.versionSearchString);
                    if (index === -1) {
                        return;
                    }
                    
                    var rv = dataString.indexOf("rv:");
                    if (this.versionSearchString === "Trident" && rv !== -1) {
                        return parseFloat(dataString.substring(rv + 3));
                    } else {
                        return parseFloat(dataString.substring(index + this.versionSearchString.length + 1));
                    }
                },
                
                dataBrowser: [
                    { string: navigator.userAgent, subString: "Edge", identity: "MS Edge" },
                    { string: navigator.userAgent, subString: "MSIE", identity: "Explorer" },
                    { string: navigator.userAgent, subString: "Trident", identity: "Explorer" },
                    { string: navigator.userAgent, subString: "Firefox", identity: "Firefox" },
                    { string: navigator.userAgent, subString: "Opera", identity: "Opera" },
                    { string: navigator.userAgent, subString: "OPR", identity: "Opera" },
                    { string: navigator.userAgent, subString: "Chrome", identity: "Chrome" },
                    { string: navigator.userAgent, subString: "Safari", identity: "Safari" }
                ]
            };
            
            BrowserDetect.init();
            if (BrowserDetect.browser == "Explorer") {
                $("#exportIE").show();
            }
            else {
                $("#exportChrome").show();
            }
        });
        
    });
    
</script>
